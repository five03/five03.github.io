<!DOCTYPE html>
<html  lang="zh">
<head>
    <meta charset="utf-8" />

<meta name="generator" content="Hexo 4.1.1" />

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<title>BLE开发-BLE协议栈及TI软件体系架构 - five03</title>


    <meta name="description" content="BLE协议栈架构 | GPA协议 | GATT协议 | TI BLE顶层软件体系架构">
<meta property="og:type" content="article">
<meta property="og:title" content="BLE开发-BLE协议栈及TI软件体系架构">
<meta property="og:url" content="http:&#x2F;&#x2F;yoursite.com&#x2F;2019&#x2F;01&#x2F;28&#x2F;BLE%E5%BC%80%E5%8F%91-BLE%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%8F%8ATI%E8%BD%AF%E4%BB%B6%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84&#x2F;index.html">
<meta property="og:site_name" content="five03">
<meta property="og:description" content="BLE协议栈架构 | GPA协议 | GATT协议 | TI BLE顶层软件体系架构">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;og_image.png">
<meta property="article:published_time" content="2019-01-28T13:07:40.000Z">
<meta property="article:modified_time" content="2019-12-21T07:15:15.080Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="BLE开发">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;og_image.png">







<link rel="icon" href="/images/favicon.svg">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css">


    
    
<style>body>.footer,body>.navbar,body>.section{opacity:0}</style>

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">

    
    
    
    
<link rel="stylesheet" href="/css/back-to-top.css">

    
    
    
    
    
    
    
    <link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
    
    
    


<link rel="stylesheet" href="/css/style.css">
</head>
<body class="is-3-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="/images/logo.svg" alt="BLE开发-BLE协议栈及TI软件体系架构" height="28">
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item"
                href="/">主页</a>
                
                <a class="navbar-item"
                href="/archives">归档</a>
                
                <a class="navbar-item"
                href="/categories">分类</a>
                
                <a class="navbar-item"
                href="/tags">标签</a>
                
                <a class="navbar-item"
                href="/about">关于</a>
                
            </div>
            
            <div class="navbar-end">
                
                    
                    <a class="navbar-item" target="_blank" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                    
                
                
                <a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;">
                    <i class="fas fa-list-ul"></i>
                </a>
                
                
                <a class="navbar-item search" title="搜索" href="javascript:;">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-8-desktop is-6-widescreen has-order-2 column-main">
<div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-01-28T13:07:40.000Z">2019-01-28</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/BLE%E5%BC%80%E5%8F%91/">BLE开发</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    1 小时 读完 (大约 7376 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                BLE开发-BLE协议栈及TI软件体系架构
            
        </h1>
        <div class="content">
            <center>BLE协议栈架构 | GPA协议 | GATT协议 | TI BLE顶层软件体系架构</center>
<a id="more"></a>

<p><strong>蓝牙</strong>是一种短距的无线通讯技术，可实现固定设备、移动设备之间的数据交换。一般将蓝牙3.0之前的BR/EDR蓝牙称为传统蓝牙，而将蓝牙4.0规范下的BLE蓝牙称为低功耗蓝牙。</p>
<p><strong>BLE即蓝牙低能耗</strong>（<strong>Bluetooth Low Energy</strong>）也称<strong>低功耗蓝牙</strong>，是蓝牙技术联盟设计和销售的一种个人局域网技术，旨在用于医疗保健、运动健身、信标、安防、家庭娱乐等领域的新兴应用。相较经典蓝牙，低功耗蓝牙旨在保持同等通信范围的同时显著降低功耗和成本。从蓝牙4.0开始支持。蓝牙低功耗芯片有两种模式：单模和双模。</p>
<ul>
<li>单模：只能执行低功耗协议栈，也就是只支持BLE。</li>
<li>双模：支持传统蓝牙以及BLE的使用。</li>
</ul>
<p><strong>特点</strong>：</p>
<ul>
<li><p>低功耗，使用 BLE 与周围设备进行通讯时，其峰值功耗为传统蓝牙的一半 </p>
</li>
<li><p>传输距离提升到 100 米 </p>
</li>
<li><p>低延时，最短可在3 ms内完成连接并开始进行数据传输</p>
</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>传输数据量较小，最大 512 个字节，超过 20 个字节需要分包处理</li>
</ul>
<p><strong>应用领域</strong>：</p>
<ul>
<li>主要用于智能硬件，比如健康护理、运动和健身、设备电源管理等</li>
</ul>
<h1 id="1-BLE协议栈架构"><a href="#1-BLE协议栈架构" class="headerlink" title="1. BLE协议栈架构"></a>1. BLE协议栈架构</h1><ol>
<li>协议有两个部分组成：<strong>Controller（控制器）</strong>和 <strong>Host（主机）</strong></li>
<li>Profiles和应用总是基于GAP和GATT之上</li>
<li>控制器与主机分离的形式来自标准的蓝牙 BR / EDR设备，这两个部分通常分别描述。任何 profiles（配置文件）和应用程序都是使用 <strong>GAP</strong> 与 <strong>GATT</strong> 层协议栈来编写程序。</li>
</ol>
<img src="/2019/01/28/BLE%E5%BC%80%E5%8F%91-BLE%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%8F%8ATI%E8%BD%AF%E4%BB%B6%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84/1.png">


<p>如上图所述，要实现一个BLE应用，首先需要一个支持BLE射频的芯片，然后还需要提供一个与此芯片配套的BLE协议栈，最后在协议栈上开发自己的应用。可以看出BLE协议栈是连接芯片和应用的桥梁，是实现整个BLE应用的关键。那BLE协议栈具体包含哪些功能呢？简单来说，BLE协议栈主要用来对你的应用数据进行<strong>层层封包</strong>，以生成一个满足BLE协议的空中数据包，也就是说，把应用数据包裹在一系列的帧头（header）和帧尾（tail）中。具体来说，BLE协议栈主要由如下几部分组成：</p>
<h2 id="1-1-控制器部分（Controller）"><a href="#1-1-控制器部分（Controller）" class="headerlink" title="1.1  控制器部分（Controller）"></a>1.1  控制器部分（Controller）</h2><ul>
<li><strong>物理层 - PHY（Physical layer）</strong> 负责数据和语音的发送和接收，特点是短距离、低功耗。是一种带宽自适应跳频 GFSK（高斯频移键控），工作在免费的工业频段2.4GHz。PHY层做得好不好，直接决定整个BLE芯片的功耗，灵敏度以及selectivity等射频指标。</li>
<li><strong>链路层 - LL（Link Layer）</strong> LL层是整个BLE协议栈的核心，也是BLE协议栈的难点和重点。像Nordic的BLE协议栈能同时支持20个link（连接），就是LL层的功劳。LL层要做的事情非常多，比如具体选择哪个射频通道进行通信，怎么识别空中数据包，具体在哪个时间点把数据包发送出去，怎么保证数据的完整性，ACK如何接收，如何进行重传，以及如何对链路进行管理和控制等等。LL层只负责把数据发出去或者收回来，对数据进行怎样的解析则交给上面的GAP或者ATT。</li>
<li><strong>主机控制接口 - HCI（Host controller interface）</strong>。向上为主机提供软件应用程序接口（API），对外为外部硬件控制接口。该层可以通过一个可编程接口来实现，该可编程接口可以是 UART，SPI 或 USB。HCI是可选的（<a href="http://www.cnblogs.com/iini/p/8834970.html" target="_blank" rel="noopener">具体请参考文章： 三种蓝牙架构实现方案（蓝牙协议栈方案）</a>），HCI主要用于2颗芯片实现BLE协议栈的场合，用来规范两者之间的通信协议和通信命令等。</li>
</ul>
<h2 id="1-2-主机部分（Host）"><a href="#1-2-主机部分（Host）" class="headerlink" title="1.2 主机部分（Host）"></a>1.2 主机部分（Host）</h2><ul>
<li><p><strong>链路逻辑控制和适配协议层 - L2CAP层（Logic link control and adaptation protocol）</strong> L2CAP对LL进行了一次简单封装，LL只关心传输的数据本身，L2CAP就要区分是加密通道还是普通通道，同时还要对连接间隔进行管理。</p>
</li>
<li><p><strong>安全管理层 - SMP（Secure manager protocol）</strong> SMP用来管理BLE连接的加密和安全的，如何保证连接的安全性，同时不影响用户的体验，这些都是SMP要考虑的工作。</p>
</li>
<li><p><strong>属性协议层 - ATT（Attribute protocol）</strong>负责数据检索，允许一个设备暴露一些数据块给其他设备，其他设备称之为“属性”。简单来说，ATT层用来定义用户命令及命令操作的数据，比如读取某个数据或者写某个数据。BLE协议栈中，开发者接触最多的就是ATT。<strong>BLE引入了attribute概念，用来描述一条一条的数据</strong>。Attribute除了定义数据，同时定义该数据可以使用的ATT命令，因此这一层被称为ATT层。</p>
</li>
<li><p><strong>通讯访问协议 - GAP（Generic access profile）</strong>是应用程配置文件的接口，用于 <strong>处理设备的发现和连接</strong> 相关的服务。GAP 还有处理安全连接等特征。是对LL层payload（有效数据包）如何进行解析的两种方式中的一种，而且是最简单的那一种。GAP简单的对LL payload进行一些规范和定义，因此GAP能实现的功能极其有限。GAP目前主要用来进行广播，扫描和发起连接等。GAP给设备定义了若干角色，其中主要的两个是：外围设备（Peripheral）和中心设备（Central）。</p>
</li>
<li><p><strong>通用属性协议层 - GATT（Generic attribute profile ）</strong> GATT用来规范attribute中的数据内容，并运用group（分组）的概念对attribute进行分类管理，BLE 中所有的数据通信都需要经过GATT。没有GATT，BLE协议栈也能跑，但互联互通就会出问题，也正是因为有了GATT和各种各样的应用profile，BLE摆脱了ZigBee等无线协议的兼容性困境，成了出货量最大的2.4G无线通信产品。</p>
<p>它定义两个 BLE 设备通过叫做 <strong>Service</strong> 和 <strong>Characteristic</strong> 的东西进行通信。GATT 就是使用了 ATT 协议，ATT 协议把 Service, Characteristic遗迹对应的数据保存在一个查找表中，次查找表使用 16 bit ID 作为每一项的索引。</p>
</li>
</ul>
<h1 id="2-GAP协议"><a href="#2-GAP协议" class="headerlink" title="2. GAP协议"></a>2. GAP协议</h1><p><strong>GAP</strong>（Generic Access Profile）的缩写，中文是通用访问协议，它在用来控制设备连接和广播；</p>
<p>GAP 使你的设备被其他设备可见，并决定了你的设备是否可以或者怎样与合同设备进行交互；</p>
<p>例如：Beacon 设备就只是向外广播，不支持连接，小米手环就等设备就可以与中心设备连接。</p>
<h2 id="2-1-GAP广播数据"><a href="#2-1-GAP广播数据" class="headerlink" title="2.1 GAP广播数据"></a>2.1 GAP广播数据</h2><p>在 GAP 中外围设备通过两种方式向外广播数据：</p>
<p><strong>Advertising Data Payload（广播数据）</strong>和 <strong>Scan Response Data Payload（扫描回复）</strong>；</p>
<p>每种数据最长可以包含 31 byte。这里广播数据是必需的，因为外设必需不停的向外广播，让中心设备知道它的存在；</p>
<p>扫描回复是可选的，中心设备可以向外设请求扫描回复，这里包含一些设备额外的信息，例如：设备的名字。</p>
<h2 id="2-2-GAP广播的网络拓扑"><a href="#2-2-GAP广播的网络拓扑" class="headerlink" title="2.2 GAP广播的网络拓扑"></a>2.2 GAP广播的网络拓扑</h2><p>大部分情况下外围设备通过广播自己来让中心设备发现自己，并建立 GATT 连接，从而进行更多的数据交换；</p>
<p>也有些情况是不需要连接的，只要外设广播自己的数据即可，用这种方式主要目的是让外围设备，把自己的信息发送给多个中心设备；</p>
<p>因为基于 GATT 连接的方式的，只能是一个外设连接一个中心设备，使用广播这种方式最典型的应用就是苹果的 iBeacon。</p>
<h2 id="2-3-GAP通信中角色"><a href="#2-3-GAP通信中角色" class="headerlink" title="2.3 GAP通信中角色"></a>2.3 GAP通信中角色</h2><p>GAP 给设备定义了若干角色，其中主要的两个是：<strong>外围设备（Peripheral - 从机 - 服务端）</strong>和 <strong>中心设备（Central - 主机 - 客户端）</strong>。</p>
<p><strong>外围设备 - 从机：</strong>这一般就是非常小或者简单的低功耗设备，用来提供数据，并连接到一个更加相对强大的中心设备，例如小米手环；</p>
<p><strong>中心设备 - 主机：</strong>中心设备相对比较强大，用来连接其他外围设备，例如手机等。</p>
<h1 id="3-GATT协议"><a href="#3-GATT协议" class="headerlink" title="3. GATT协议"></a>3. GATT协议</h1><p><strong>GATT</strong>（Generic Attributes Profile）的缩写，中文是通用属性协议，是已连接的低功耗蓝牙设备之间进行通信的协议。一旦两个设备建立起了连接，GATT 就开始起作用了，这也意味着，你必需完成前面的GAP协议。</p>
<p>GATT使用了 <strong>ATT</strong>（Attribute Protocol）协议，ATT 协议把 Service，Characteristic 对应的数据保存在一个查找表中，查找表使用 16bit ID 作为每一项的索引。</p>
<p>GATT定义的多层数据结构简要概括起来就是 <strong>服务（Service）</strong> 可以包含多个 <strong>特征（Characteristic）</strong>，每个特征包含 <strong>属性（Properties）</strong> 和 <strong>值（Value）</strong>，还可以包含多个 <strong>描述（Descriptor）</strong>。</p>
<h2 id="3-1-GATT结构"><a href="#3-1-GATT结构" class="headerlink" title="3.1 GATT结构"></a>3.1 GATT结构</h2><p><img src="/2019/01/28/BLE%E5%BC%80%E5%8F%91-BLE%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%8F%8ATI%E8%BD%AF%E4%BB%B6%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84/7.png" alt="GATT架构"></p>
<ul>
<li><p><strong>Profile（规范）</strong>：</p>
<p>profile 可以理解为一种规范，一个标准的通信协议，它存在于蓝牙从机中（服务端）；</p>
<p>蓝牙组织规定了一些标准的 profile，例如 HID OVER GATT，防丢器，心率计等；</p>
<p>每个 profile 中会包含多个 service，每个 service 代表从机的一种能力。</p>
</li>
<li><p><strong>Service（服务）</strong></p>
<p>service 可以理解为一个服务，在 BLE 从机中有多个服务，例如：电量信息服务、系统信息服务等；</p>
<p>每个 service 中又包含多个 characteristic 特征值；</p>
<p>每个具体的 characteristic 特征值才是 BLE 通信的主题，比如当前的电量是 80%，电量的 characteristic 特征值存在从机的 profile 里，这样主机就可以通过这个 characteristic 来读取 80% 这个数据。</p>
</li>
<li><p><strong>Characteristic（特征）</strong></p>
<p>characteristic 特征，BLE 主从机的通信均是通过 characteristic 来实现，可以理解为一个标签，通过这个标签可以获取或者写入想要的内容。</p>
</li>
<li><p><strong>UUID（通用唯一识别码）</strong></p>
<p>uuid 通用唯一识别码，我们刚才提到的 service 和 characteristic 都需要一个唯一的 uuid 来标识；</p>
<p>每个从机都会有一个 profile，不管是自定义的 simpleprofile，还是标准的防丢器 profile，他们都是由一些 service 组成，每个 service 又包含了多个 characteristic，主机和从机之间的通信，均是通过characteristic来实现。</p>
</li>
</ul>
<h2 id="3-2-GATT连接的网络拓扑"><a href="#3-2-GATT连接的网络拓扑" class="headerlink" title="3.2 GATT连接的网络拓扑"></a>3.2 GATT连接的网络拓扑</h2><p>一个外围设备（从机）只能连接一个中心设备（主机），而一个中心设备（主机）可以连接多个外围设备（从机），一旦建立起了连接，通信就是双向的了，对比前面的 GAP 广播的网络拓扑，GAP 通信是单向的，如果你要让两个设备外围设备（从机）之间能够通信，就只能通过中心设备（主机）中转。</p>
<h2 id="3-3-GATT通信中角色"><a href="#3-3-GATT通信中角色" class="headerlink" title="3.3 GATT通信中角色"></a>3.3 GATT通信中角色</h2><p>从GATT的角度来看，处于连接状态时的两个设备，它们各自充当两种角色中的一种：</p>
<ul>
<li><p><strong>服务端（Server）</strong></p>
<p>包含被GATT客户端读取或写入的特征数据的设备。</p>
</li>
<li><p><strong>客户端（Client）</strong></p>
<p>从GATT服务器中读取数据或向GATT服务器写入数据的设备。</p>
</li>
</ul>
<p>外围设备（从机）作为 GATT 服务端（Server），它维持了 ATT 的查找表以及 service 和 characteristic 的定义，客户端和服务器的GATT角色独立于外围设备和中央设备的GAP角色。</p>
<p><strong>外围设备可以是GATT客户端或GATT服务器，中心可以是GATT客户端或GATT服务器</strong>，一旦连接建立，外设将会给中心设备建议一个连接间隔（Connection Interval），这样中心设备就会在每个连接间隔尝试去重新连接，检查是否有新的数据；</p>
<p>但是，这个连接间隔只是一个建议，你的中心设备可能并不会严格按照这个间隔来执行，例如你的中心设备正在忙于连接其他的外设，或者中心设备资源太忙。</p>
<p><img src="/2019/01/28/BLE%E5%BC%80%E5%8F%91-BLE%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%8F%8ATI%E8%BD%AF%E4%BB%B6%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84/8.png" alt="GATT客户端和服务器交互"></p>
<h2 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h2><p>我相信很多人看了上面的介绍，还是不懂BLE协议栈的工作原理，以及每一层具体干什么的，为什么要这么分层。下面我以如何发送一个数据包为例来讲解BLE协议栈各层是如何紧密配合，以完成发送任务的。</p>
<h3 id="如何通过无线发送一个数据包"><a href="#如何通过无线发送一个数据包" class="headerlink" title="如何通过无线发送一个数据包"></a>如何通过无线发送一个数据包</h3><p>假设有设备A和设备B，设备A要把自己目前的电量状态83%（十六进制表示为0x53）发给设备B，该怎么做呢？作为一个开发者，他希望越简单越好，对他而言，他希望调用一个简单的API就能完成这件事，比如send(0x53)，实际上我们的BLE协议栈就是这样设计的，开发者只需调用send(0x53)就可以把数据发送出去了，其余的事情BLE协议栈帮你搞定。很多人会想，BLE协议栈是不是直接在物理层就把0x53发出去，就如下图所示：</p>
<p><img src="/2019/01/28/BLE%E5%BC%80%E5%8F%91-BLE%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%8F%8ATI%E8%BD%AF%E4%BB%B6%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84/3-1.png" alt="3-1"></p>
<p>这种方式初看起来挺美的，但由于很多细节没有考虑到，实际是不可行的。首先，它没有考虑用哪一个射频信道来进行传输，在不更改API的情况下，我们只能对协议栈进行分层，为此引入LL层，开发者还是调用send(0x53)，send(0x53)再调用send_LL(0x53,2402M)（注：2402M为信道频率）。这里还有一个问题，设备B怎么知道这个数据包是发给自己的还是其他人的，为此BLE引入<strong>access address概念，用来指明接收者身份</strong>，其中，0x8E89BED6这个access address比较特殊，它表示要发给周边所有设备，即广播。如果你要一对一的进行通信（BLE协议将其称为<strong>连接</strong>），即设备A的数据包只能设备B接收，同样设备B的数据包只能设备A接收，那么就必须生成一个独特的<strong>随机</strong>access address以标识设备A和设备B两者之间的连接。</p>
<h3 id="广播方式"><a href="#广播方式" class="headerlink" title="广播方式"></a>广播方式</h3><p>我们先来看一下简单的广播情况，这种情况下，我们把设备A叫<strong>advertiser</strong>（广播者），设备B叫<strong>scanner</strong>或者<strong>observer</strong>（扫描者）。广播状态下设备A的LL层API将变成send_LL(0x53,2402M, 0x8E89BED6)。由于设备B可以同时接收到很多设备的广播，因此数据包还必须包含设备A的device address（0xE1022AAB753B）以确认该广播包来自设备A，为此send_LL参数需要变成(0x53,2402M, 0x8E89BED6, 0xE1022AAB753B)。LL层还要检查数据的完整性，即数据在传输过程中有没有发生窜改，为此引入CRC24对数据包进行检验 (假设为0xB2C78E) 。同时为了调制解调电路工作更高效，每一个数据包的最前面会加上1个字节的preamble（前导帧），preamble一般为0x55或者0xAA。这样，整个空中包就变成（注：<strong>空中包用小端模式表示！</strong>）：</p>
<p>![3-2](BLE开发-BLE协议栈及TI软件体系架构/3-2 .png)</p>
<p>上面这个数据包还有如下问题：</p>
<ol>
<li>没有对数据包进行分类组织，设备B无法找到自己想要的数据0x53。为此我们需要在access address之后加入两个字段：LL header和长度字节。LL header用来表示数据包的LL类型，长度字节用来指明payload的长度</li>
<li>设备B什么时候开启射频窗口以接收空中数据包？如上图case1所示，当设备A的数据包在空中传输的时候，设备B把接收窗口关闭，此时通信将失败；同样对case2来说，当设备A没有在空中发送数据包时，设备B把接收窗口打开，此时通信也将失败。只有case3的情况，通信才能成功，即设备A的数据包在空中传输时，设备B正好打开射频接收窗口，此时通信才能成功，换句话说，<strong>LL层还必须定义通信时序</strong>。</li>
<li>当设备B拿到数据0x53后，该如何解析这个数据呢？它到底表示湿度还是电量，还是别的意思？这个就是GAP层要做的工作，GAP层引入了LTV（Length-Type-Value）结构来定义数据，比如020105，02-长度，01-类型（强制字段，表示广播flag，广播包必须包含该字段），05-值。由于广播包最大只能为31个字节，它能定义的数据类型极其有限，像这里说的电量，GAP就没有定义，因此要通过广播方式把电量数据发出去，只能使用供应商自定义数据类型0xFF，即04FF590053，其中04表示长度，FF表示数据类型（自定义数据），0x0059是供应商ID（自定义数据中的强制字段），0x53就是我们的数据(设备双方约定0x53就是表示电量，而不是其他意思)。</li>
</ol>
<p>最终空中传输的数据包将变成：</p>
<ul>
<li>AA - D6BE898E - 60 - 0E - 3B75AB2A02E1 - 02010504FF590053 - 8EC7B2<ul>
<li>AA – 前导帧(preamble)</li>
<li>D6BE898E – 访问地址(access address)</li>
<li>60 – LL帧头字段(LL header)</li>
<li>0E – 有效数据包长度(payload length)</li>
<li>3B75AB2A02E1 – 广播者设备地址(advertiser address)</li>
<li>02010504FF5900<strong>53 – 广播数据</strong></li>
<li>8EC7B2 – CRC24值</li>
</ul>
</li>
</ul>
<p><img src="/2019/01/28/BLE%E5%BC%80%E5%8F%91-BLE%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%8F%8ATI%E8%BD%AF%E4%BB%B6%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84/4.png" alt="4"></p>
<p>有了PHY，LL和GAP，就可以发送广播包了，但广播包携带的信息极其有限，而且还有如下几大限制：</p>
<ol>
<li>无法进行一对一通信 （广播是一对多通信，而且是单方向的通信）</li>
<li>由于不支持组包和拆包，因此无法传输大数据</li>
<li>通信不可靠。广播信道不能太多，否则将导致扫描端效率低下。为此，BLE只使用37(2402MHz) /38(2426MHz) /39(2480MHz)三个信道进行广播和扫描，因此广播不支持跳频。由于广播是一对多的，所以广播也无法支持ACK。这些都使广播通信变得不可靠。</li>
<li>扫描端功耗高。由于扫描端不知道设备端何时广播，也不知道设备端选用哪个频道进行广播，扫描端只能拉长扫描窗口时间，并同时对37/38/39三个通道进行扫描，这样功耗就会比较高。</li>
</ol>
<p>而连接则可以很好解决上述问题，下面我们就来看看连接是如何将0x53发送出去的。</p>
<h3 id="连接方式"><a href="#连接方式" class="headerlink" title="连接方式"></a>连接方式</h3><p>到底什么叫连接(connection)？像有线UART，很容易理解，就是用线（Rx和Tx等）把设备A和设备B相连，即为连接。用“线”把两个设备相连，实际是让2个设备有共同的通信媒介，并让两者时钟同步起来。蓝牙连接有何尝不是这个道理，<strong>所谓设备A和设备B建立蓝牙连接，就是指设备A和设备B两者“同步”成功</strong>，其具体包含以下几方面：</p>
<ul>
<li>设备A和设备B对接下来要使用的物理信道达成一致</li>
<li>设备A和设备B双方建立一个共同的时间锚点，也就是说，把双方的时间原点变成同一个点</li>
<li>设备A和设备B两者时钟同步成功，即双方都知道对方什么时候发送数据包什么时候接收数据包</li>
<li>连接成功后，设备A和设备B通信流程如下所示：</li>
</ul>
<p><img src="/2019/01/28/BLE%E5%BC%80%E5%8F%91-BLE%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%8F%8ATI%E8%BD%AF%E4%BB%B6%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84/5.png" alt="5"></p>
<p>如上图所示，一旦设备A和设备B连接成功（此种情况下，我们把设备A称为<strong>Master</strong>或者<strong>Central</strong>，把设备B称为<strong>Slave</strong>或者<strong>Peripheral</strong>），设备A将周期性以CI（connection interval）为间隔向设备B发送数据包，而设备B也周期性地以CI为间隔打开射频接收窗口以接收设备A的数据包。同时按照蓝牙spec要求，设备B收到设备A数据包<strong>150us后</strong>，设备B切换到发送状态，把自己的数据发给设备A；设备A则切换到接收状态，接收设备B发过来的数据。由此可见，连接状态下，设备A和设备B的射频发送和接收窗口都是周期性地有计划地开和关，而且开的时间非常短，从而大大减低系统功耗并大大提高系统效率。</p>
<p>现在我们看看连接状态下是如何把数据0x53发送出去的，从中大家可以体会到蓝牙协议栈分层的妙处。</p>
<ul>
<li>对开发者来说，很简单，他只需要调用send(0x53)</li>
<li>GATT层定义数据的类型和分组，方便起见，我们用0x0013表示电量这种数据类型，这样GATT层把数据打包成130053（<strong>小端模式</strong>！）</li>
<li>ATT层用来选择具体的通信命令，比如读/写/notify/indicate等，这里选择notify命令0x1B，这样数据包变成了：1B130053</li>
<li>L2CAP用来指定connection interval（连接间隔），比如每10ms同步一次（CI不体现在数据包中），同时指定逻辑通道编号0004（表示ATT命令），最后把ATT数据长度0x0004加在包头，这样数据就变为：040004001B130053</li>
<li>LL层要做的工作很多，首先LL层需要指定用哪个物理信道进行传输（物理信道不体现在数据包中），然后再给此连接分配一个Access address（0x50655DAB）以标识此连接只为设备A和设备B直连服务，然后加上LL header和payload length字段，LL header标识此packet为数据packet，而不是control packet等，payload length为整个L2CAP字段的长度，最后加上CRC24字段，以保证整个packet的数据完整性，所以数据包最后变成：<ul>
<li>AAAB5D65501E08040004001B130053D550F6<ul>
<li>AA – 前导帧(preamble)</li>
<li>0x50655DAB – 访问地址(access address)</li>
<li>1E – LL帧头字段(LL header)</li>
<li>08 – 有效数据包长度(payload length)</li>
<li>04000400 – ATT数据长度，以及L2CAP通道编号</li>
<li>1B – notify command</li>
<li>0x0013 – 电量数据handle</li>
<li>0x53 – 真正要发送的电量数据</li>
<li>0xF650D5 – CRC24值</li>
<li>虽然开发者只调用了 send(0x53)，但由于低功耗蓝牙协议栈层层打包，最后空中实际传输的数据将变成下图所示的模样，这就既满足了低功耗蓝牙通信的需求，又让用户API变得简单，可谓一箭双雕！</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="/2019/01/28/BLE%E5%BC%80%E5%8F%91-BLE%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%8F%8ATI%E8%BD%AF%E4%BB%B6%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84/6.png" alt="6"></p>
<p>上面只是对BLE协议栈实现原理做了一个简单概述，即便如此，由于都是关于BLE协议栈底层的东西，很多开发者还是会觉得比较枯燥和晦涩，而且对很多开发者来说，他们也不关心BLE协议栈是如何实现的，他们更关心的是BLE协议栈的使用，即怎么开发一个BLE应用。</p>
<h1 id="4-TI-BLE顶层软件体系架构"><a href="#4-TI-BLE顶层软件体系架构" class="headerlink" title="4. TI BLE顶层软件体系架构"></a>4. TI BLE顶层软件体系架构</h1><p><img src="/2019/01/28/BLE%E5%BC%80%E5%8F%91-BLE%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%8F%8ATI%E8%BD%AF%E4%BB%B6%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84/9.png" alt="9"></p>
<p>在顶层，CC2640 软件环境包括三个部分：<strong>实时操作系统（RTOS），应用和协议栈</strong>。</p>
<p><strong>TI-RTOS</strong> 是一个实时的操作系统，具备多线程操作和任务同步等功能。</p>
<p>APP 应用和 BLE 协议栈作为单独的任务存在于 RTOS 中，BLE 协议栈具有最高优先级。间接访问（ICall）的消息框架被用于线程的同步和栈的通信：</p>
<p>协议栈：这包括低层的 BLE 协议栈链路层(LL)到 GAP 与 GAPP 的通信，如图1所示。大多数的 BLE 协议栈代码作为库提供。</p>
<p>应用：这包括相关的配置文件，应用程序，驱动程序，和 ICall 模块。</p>
<h2 id="4-1-标准项目任务层次"><a href="#4-1-标准项目任务层次" class="headerlink" title="4.1 标准项目任务层次"></a>4.1 标准项目任务层次</h2><p>所有的项目都会包含至少三个实时操作系统的任务 Task。例如 simplebleperipheral 项目，这些任务是以及他们的任务优先级为：<br> <strong>5： BLE 协议栈的任务</strong><br> <strong>3：GapRole 任务（从机角色）</strong><br> <strong>1：应用任务（simplebleperipheral）</strong></p>
<h2 id="4-2-ICall"><a href="#4-2-ICall" class="headerlink" title="4.2 ICall"></a>4.2 ICall</h2><p><strong>ICall（Indirect Call Framework）</strong>的调用可以实现应用程序的与 BLE 协议栈的通信（例如，线程同步）。</p>
<p>ICall 模块的源代码被包含在 IDE 的 应用工程的 “ICall” 与 “ICallBLE” 文件夹内。 IAR 如下（CCS 类似）：</p>
<p><img src="/2019/01/28/BLE%E5%BC%80%E5%8F%91-BLE%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%8F%8ATI%E8%BD%AF%E4%BB%B6%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84/10.png" alt="10"></p>
<h3 id="4-2-1-ICall-BLE-协议栈的服务"><a href="#4-2-1-ICall-BLE-协议栈的服务" class="headerlink" title="4.2.1 ICall BLE 协议栈的服务"></a>4.2.1 ICall BLE 协议栈的服务</h3><p><img src="/2019/01/28/BLE%E5%BC%80%E5%8F%91-BLE%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%8F%8ATI%E8%BD%AF%E4%BB%B6%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84/11.png" alt="11"></p>
<p>如图6的所示，ICall 可以监听协议栈（服务端）与应用程序（客户端）间的消息，注意不要把 ICall 的框架结构 与 BLE 中的 GATT 的 S/C 结构混淆，这样做的原因是为了方便应用软件与 RTOS 操作系统的升级，而不会互相耦合影响， 并且更方便把 CC254x 的代码已知道 CC2640 系列芯片上来。</p>
<p>本质上，当应用程序调用 BLE 协议栈的 API 函数时，由 ICall 发指令给 BLE 协议栈，反过来，协议栈发出来的消息也是 ICall 来传递的。</p>
<p>因为 ICall 模块是应用程序项目的一部分，应用程序可以直接访问 ICall 的函数。请注意，由于 BLE 协议栈具有最高优先级，因此应用程序任务将阻塞直到收到响应。应用程序阻塞期间，BLE 协议栈也可以异步地通过 ICall 通知应用程序某个消息（例如，事件更新）。</p>
<hr>
<p>整理自：</p>
<p><a href="https://blog.csdn.net/shunfa888/article/details/80140475" target="_blank" rel="noopener">深入浅出低功耗蓝牙(BLE)协议栈</a>       [Leung_ManWah]<br><a href="https://www.jianshu.com/p/0ee56ba0bd27" target="_blank" rel="noopener">CC2640学习笔记（3）——BLE协议栈及TI软件体系架构</a>    [shunfa888]<br><a href="https://blog.csdn.net/u011371324/article/details/80568230" target="_blank" rel="noopener">Android 蓝牙开发 —— BLE</a>    [RalfNick]</p>
<p>拓展：</p>
<p><a href="https://www.cnblogs.com/smart-mutouren/p/5937990.html" target="_blank" rel="noopener"><a href="https://www.cnblogs.com/smart-mutouren/p/5937990.html" target="_blank" rel="noopener">BLE GATT 介绍</a></a></p>

        </div>
        
        <div class="level is-size-7 is-uppercase">
            <div class="level-start">
                <div class="level-item">
                    <span class="is-size-6 has-text-grey has-mr-7">#</span>
                    <a class="has-link-grey -link" href="/tags/BLE%E5%BC%80%E5%8F%91/" rel="tag">BLE开发</a>
                </div>
            </div>
        </div>
        
        
        
    </div>
</div>





<div class="card card-transparent">
    <div class="level post-navigation is-flex-wrap is-mobile">
        
        <div class="level-start">
            <a class="level level-item has-link-grey  article-nav-prev" href="/2019/01/29/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/">
                <i class="level-item fas fa-chevron-left"></i>
                <span class="level-item">微信小程序</span>
            </a>
        </div>
        
        
        <div class="level-end">
            <a class="level level-item has-link-grey  article-nav-next" href="/2019/01/28/Android%E5%BC%80%E5%8F%91-%E9%80%82%E9%85%8D%E5%99%A8/">
                <span class="level-item">④Android开发-适配器（一）</span>
                <i class="level-item fas fa-chevron-right"></i>
            </a>
        </div>
        
    </div>
</div>



<div class="card">
    <div class="card-content">
        <h3 class="title is-5 has-text-weight-normal">评论</h3>
        
<script>
    var disqus_config = function () {
        this.page.url = 'http://yoursite.com/2019/01/28/BLE%E5%BC%80%E5%8F%91-BLE%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%8F%8ATI%E8%BD%AF%E4%BB%B6%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84/';
        this.page.identifier = '2019/01/28/BLE开发-BLE协议栈及TI软件体系架构/';
    };
    (function() {
        var d = document, s = d.createElement('script');  
        s.src = '//' + '不能为空' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>

<div id="disqus_thread">
    
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
</div>
    </div>
</div>
</div>
                




<div class="column is-4-tablet is-4-desktop is-3-widescreen  has-order-1 column-left is-sticky">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered" style="flex-shrink: 1">
                <div>
                    
                    <figure class="image is-128x128 has-mb-6">
                        <img class="" src="/images/head.png" alt="Hu">
                    </figure>
                    
                    <p class="is-size-4 is-block">
                        Hu
                    </p>
                    
                    
                    <p class="is-size-6 is-block">
                        Student
                    </p>
                    
                    
                </div>
            </div>
        </nav>
        <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        文章
                    </p>
                    <a href="/archives">
                        <p class="title has-text-weight-normal">
                            15
                        </p>
                    </a>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        分类
                    </p>
                    <a href="/categories">
                        <p class="title has-text-weight-normal">
                            4
                        </p>
                    </a>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        标签
                    </p>
                    <a href="/tags">
                        <p class="title has-text-weight-normal">
                            4
                        </p>
                    </a>
                </div>
            </div>
        </nav>
        
        
        
    </div>
</div>
    
        
<div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                分类
            </h3>
            <ul class="menu-list">
            <li>
        <a class="level is-marginless" href="/categories/Android%E5%BC%80%E5%8F%91/">
            <span class="level-start">
                <span class="level-item">Android开发</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">9</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/BLE%E5%BC%80%E5%8F%91/">
            <span class="level-start">
                <span class="level-item">BLE开发</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">2</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/C/">
            <span class="level-start">
                <span class="level-item">C++</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">2</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/">
            <span class="level-start">
                <span class="level-item">微信小程序</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li>
            </ul>
        </div>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            归档
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2019/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/02/">
                <span class="level-start">
                    <span class="level-item">二月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/01/">
                <span class="level-start">
                    <span class="level-item">一月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
    
    
        <div class="column-right-shadow is-hidden-widescreen ">
        
            <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            链接
        </h3>
        <ul class="menu-list">
        
            <li>
                <a class="level is-mobile" href="https://hexo.io" target="_blank">
                    <span class="level-left">
                        <span class="level-item">Hexo</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">hexo.io</span>
                    </span>
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://github.com/ppoffice" target="_blank">
                    <span class="level-left">
                        <span class="level-item">PPOffice</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">github.com</span>
                    </span>
                </a>
            </li>
        
        </ul>
        </div>
    </div>
</div>

        
            <div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            
            <a href="/2019/12/20/C-STL-2/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="C++标准模板库STL(二)">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-12-20T13:40:07.000Z">2019-12-20</time></div>
                    <a href="/2019/12/20/C-STL-2/" class="title has-link-black-ter is-size-6 has-text-weight-normal">C++标准模板库STL(二)</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/C/">C++</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2019/12/20/C-STL-1/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="C++标准模板库STL(一)">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-12-20T13:39:07.000Z">2019-12-20</time></div>
                    <a href="/2019/12/20/C-STL-1/" class="title has-link-black-ter is-size-6 has-text-weight-normal">C++标准模板库STL(一)</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/C/">C++</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2019/02/27/BLE%E5%BC%80%E5%8F%91-Android%E7%A8%8B%E5%BA%8F/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="BLE开发-Android程序">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-02-27T11:53:30.395Z">2019-02-27</time></div>
                    <a href="/2019/02/27/BLE%E5%BC%80%E5%8F%91-Android%E7%A8%8B%E5%BA%8F/" class="title has-link-black-ter is-size-6 has-text-weight-normal">BLE开发-Android程序</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/BLE%E5%BC%80%E5%8F%91/">BLE开发</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2019/02/17/Android%E5%BC%80%E5%8F%91-%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="⑨Android开发-网络通信">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-02-17T08:51:33.000Z">2019-02-17</time></div>
                    <a href="/2019/02/17/Android%E5%BC%80%E5%8F%91-%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1/" class="title has-link-black-ter is-size-6 has-text-weight-normal">⑨Android开发-网络通信</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Android%E5%BC%80%E5%8F%91/">Android开发</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2019/02/15/Android%E5%BC%80%E5%8F%91-Activity2/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="⑧Android开发-Activity（二）">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-02-15T13:04:15.000Z">2019-02-15</time></div>
                    <a href="/2019/02/15/Android%E5%BC%80%E5%8F%91-Activity2/" class="title has-link-black-ter is-size-6 has-text-weight-normal">⑧Android开发-Activity（二）</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Android%E5%BC%80%E5%8F%91/">Android开发</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>
        
            <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                标签
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Android%E5%BC%80%E5%8F%91/">
                        <span class="tag">Android开发</span>
                        <span class="tag is-grey">9</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/BLE%E5%BC%80%E5%8F%91/">
                        <span class="tag">BLE开发</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/C/">
                        <span class="tag">C++</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/">
                        <span class="tag">微信小程序</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
        
            

    <div class="card widget" id="toc" style="position:sticky; top: 20px; transition: all 2s;">
        <div class="card-content">
            <div class="menu">
                <h3 class="menu-label">
                    目录
                </h3>
                <ul class="menu-list"><li>
        <a class="is-flex" href="#1-BLE协议栈架构">
        <span class="has-mr-6">1</span>
        <span>1. BLE协议栈架构</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#1-1-控制器部分（Controller）">
        <span class="has-mr-6">1.1</span>
        <span>1.1  控制器部分（Controller）</span>
        </a></li><li>
        <a class="is-flex" href="#1-2-主机部分（Host）">
        <span class="has-mr-6">1.2</span>
        <span>1.2 主机部分（Host）</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#2-GAP协议">
        <span class="has-mr-6">2</span>
        <span>2. GAP协议</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#2-1-GAP广播数据">
        <span class="has-mr-6">2.1</span>
        <span>2.1 GAP广播数据</span>
        </a></li><li>
        <a class="is-flex" href="#2-2-GAP广播的网络拓扑">
        <span class="has-mr-6">2.2</span>
        <span>2.2 GAP广播的网络拓扑</span>
        </a></li><li>
        <a class="is-flex" href="#2-3-GAP通信中角色">
        <span class="has-mr-6">2.3</span>
        <span>2.3 GAP通信中角色</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#3-GATT协议">
        <span class="has-mr-6">3</span>
        <span>3. GATT协议</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#3-1-GATT结构">
        <span class="has-mr-6">3.1</span>
        <span>3.1 GATT结构</span>
        </a></li><li>
        <a class="is-flex" href="#3-2-GATT连接的网络拓扑">
        <span class="has-mr-6">3.2</span>
        <span>3.2 GATT连接的网络拓扑</span>
        </a></li><li>
        <a class="is-flex" href="#3-3-GATT通信中角色">
        <span class="has-mr-6">3.3</span>
        <span>3.3 GATT通信中角色</span>
        </a></li><li>
        <a class="is-flex" href="#举例">
        <span class="has-mr-6">3.4</span>
        <span>举例</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#如何通过无线发送一个数据包">
        <span class="has-mr-6">3.4.1</span>
        <span>如何通过无线发送一个数据包</span>
        </a></li><li>
        <a class="is-flex" href="#广播方式">
        <span class="has-mr-6">3.4.2</span>
        <span>广播方式</span>
        </a></li><li>
        <a class="is-flex" href="#连接方式">
        <span class="has-mr-6">3.4.3</span>
        <span>连接方式</span>
        </a></li></ul></li></ul></li><li>
        <a class="is-flex" href="#4-TI-BLE顶层软件体系架构">
        <span class="has-mr-6">4</span>
        <span>4. TI BLE顶层软件体系架构</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#4-1-标准项目任务层次">
        <span class="has-mr-6">4.1</span>
        <span>4.1 标准项目任务层次</span>
        </a></li><li>
        <a class="is-flex" href="#4-2-ICall">
        <span class="has-mr-6">4.2</span>
        <span>4.2 ICall</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#4-2-1-ICall-BLE-协议栈的服务">
        <span class="has-mr-6">4.2.1</span>
        <span>4.2.1 ICall BLE 协议栈的服务</span>
        </a></li></ul></li></ul></li></ul>
            </div>
        </div>
    </div>

        
        </div>
    
</div>

                




<div class="column is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only has-order-3 column-right ">
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            链接
        </h3>
        <ul class="menu-list">
        
            <li>
                <a class="level is-mobile" href="https://hexo.io" target="_blank">
                    <span class="level-left">
                        <span class="level-item">Hexo</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">hexo.io</span>
                    </span>
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://github.com/ppoffice" target="_blank">
                    <span class="level-left">
                        <span class="level-item">PPOffice</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">github.com</span>
                    </span>
                </a>
            </li>
        
        </ul>
        </div>
    </div>
</div>

    
        <div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            
            <a href="/2019/12/20/C-STL-2/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="C++标准模板库STL(二)">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-12-20T13:40:07.000Z">2019-12-20</time></div>
                    <a href="/2019/12/20/C-STL-2/" class="title has-link-black-ter is-size-6 has-text-weight-normal">C++标准模板库STL(二)</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/C/">C++</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2019/12/20/C-STL-1/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="C++标准模板库STL(一)">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-12-20T13:39:07.000Z">2019-12-20</time></div>
                    <a href="/2019/12/20/C-STL-1/" class="title has-link-black-ter is-size-6 has-text-weight-normal">C++标准模板库STL(一)</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/C/">C++</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2019/02/27/BLE%E5%BC%80%E5%8F%91-Android%E7%A8%8B%E5%BA%8F/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="BLE开发-Android程序">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-02-27T11:53:30.395Z">2019-02-27</time></div>
                    <a href="/2019/02/27/BLE%E5%BC%80%E5%8F%91-Android%E7%A8%8B%E5%BA%8F/" class="title has-link-black-ter is-size-6 has-text-weight-normal">BLE开发-Android程序</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/BLE%E5%BC%80%E5%8F%91/">BLE开发</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2019/02/17/Android%E5%BC%80%E5%8F%91-%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="⑨Android开发-网络通信">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-02-17T08:51:33.000Z">2019-02-17</time></div>
                    <a href="/2019/02/17/Android%E5%BC%80%E5%8F%91-%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1/" class="title has-link-black-ter is-size-6 has-text-weight-normal">⑨Android开发-网络通信</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Android%E5%BC%80%E5%8F%91/">Android开发</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2019/02/15/Android%E5%BC%80%E5%8F%91-Activity2/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="⑧Android开发-Activity（二）">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-02-15T13:04:15.000Z">2019-02-15</time></div>
                    <a href="/2019/02/15/Android%E5%BC%80%E5%8F%91-Activity2/" class="title has-link-black-ter is-size-6 has-text-weight-normal">⑧Android开发-Activity（二）</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Android%E5%BC%80%E5%8F%91/">Android开发</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                标签
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Android%E5%BC%80%E5%8F%91/">
                        <span class="tag">Android开发</span>
                        <span class="tag is-grey">9</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/BLE%E5%BC%80%E5%8F%91/">
                        <span class="tag">BLE开发</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/C/">
                        <span class="tag">C++</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/">
                        <span class="tag">微信小程序</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
    
        

    <div class="card widget" id="toc" style="position:sticky; top: 20px; transition: all 2s;">
        <div class="card-content">
            <div class="menu">
                <h3 class="menu-label">
                    目录
                </h3>
                <ul class="menu-list"><li>
        <a class="is-flex" href="#1-BLE协议栈架构">
        <span class="has-mr-6">1</span>
        <span>1. BLE协议栈架构</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#1-1-控制器部分（Controller）">
        <span class="has-mr-6">1.1</span>
        <span>1.1  控制器部分（Controller）</span>
        </a></li><li>
        <a class="is-flex" href="#1-2-主机部分（Host）">
        <span class="has-mr-6">1.2</span>
        <span>1.2 主机部分（Host）</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#2-GAP协议">
        <span class="has-mr-6">2</span>
        <span>2. GAP协议</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#2-1-GAP广播数据">
        <span class="has-mr-6">2.1</span>
        <span>2.1 GAP广播数据</span>
        </a></li><li>
        <a class="is-flex" href="#2-2-GAP广播的网络拓扑">
        <span class="has-mr-6">2.2</span>
        <span>2.2 GAP广播的网络拓扑</span>
        </a></li><li>
        <a class="is-flex" href="#2-3-GAP通信中角色">
        <span class="has-mr-6">2.3</span>
        <span>2.3 GAP通信中角色</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#3-GATT协议">
        <span class="has-mr-6">3</span>
        <span>3. GATT协议</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#3-1-GATT结构">
        <span class="has-mr-6">3.1</span>
        <span>3.1 GATT结构</span>
        </a></li><li>
        <a class="is-flex" href="#3-2-GATT连接的网络拓扑">
        <span class="has-mr-6">3.2</span>
        <span>3.2 GATT连接的网络拓扑</span>
        </a></li><li>
        <a class="is-flex" href="#3-3-GATT通信中角色">
        <span class="has-mr-6">3.3</span>
        <span>3.3 GATT通信中角色</span>
        </a></li><li>
        <a class="is-flex" href="#举例">
        <span class="has-mr-6">3.4</span>
        <span>举例</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#如何通过无线发送一个数据包">
        <span class="has-mr-6">3.4.1</span>
        <span>如何通过无线发送一个数据包</span>
        </a></li><li>
        <a class="is-flex" href="#广播方式">
        <span class="has-mr-6">3.4.2</span>
        <span>广播方式</span>
        </a></li><li>
        <a class="is-flex" href="#连接方式">
        <span class="has-mr-6">3.4.3</span>
        <span>连接方式</span>
        </a></li></ul></li></ul></li><li>
        <a class="is-flex" href="#4-TI-BLE顶层软件体系架构">
        <span class="has-mr-6">4</span>
        <span>4. TI BLE顶层软件体系架构</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#4-1-标准项目任务层次">
        <span class="has-mr-6">4.1</span>
        <span>4.1 标准项目任务层次</span>
        </a></li><li>
        <a class="is-flex" href="#4-2-ICall">
        <span class="has-mr-6">4.2</span>
        <span>4.2 ICall</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#4-2-1-ICall-BLE-协议栈的服务">
        <span class="has-mr-6">4.2.1</span>
        <span>4.2.1 ICall BLE 协议栈的服务</span>
        </a></li></ul></li></ul></li></ul>
            </div>
        </div>
    </div>

    
    
</div>

            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="/images/logo.svg" alt="BLE开发-BLE协议栈及TI软件体系架构" height="28">
                
                </a>
                <p class="is-size-7">
                &copy; 2019 John Doe&nbsp;
                Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & <a
                        href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a>
                
                </p>
            </div>
            <div class="level-end">
            
                <div class="field has-addons is-flex-center-mobile has-mt-5-mobile is-flex-wrap is-flex-middle">
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Creative Commons" href="https://creativecommons.org/">
                        
                        <i class="fab fa-creative-commons"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/">
                        
                        <i class="fab fa-creative-commons-by"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                </p>
                
                </div>
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("zh-CN");</script>

<script>
var IcarusThemeSettings = {
    article: {
        highlight: {
            clipboard: true,
            fold: 'unfolded'
        }
    }
};
</script>


    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>



    
    
<script src="/js/animation.js"></script>

    
    
<script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
<script src="/js/gallery.js" defer></script>

    
    
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/" target="_blank" rel="noopener">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>

    
    <script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>
    
    
<a id="back-to-top" title="回到顶端" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>

    
    
    
    
    
    
    
    
    
    
    


<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="想要查找什么..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(无标题)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
    <script color="0,0,0" opacity="0.5" count="99" src="https://cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.js" type="text/javascript" charset="utf-8"></script>
</body>
</html>